function t(t,e){return Math.random()*(e-t)+t}function e(t){return t[Math.floor(Math.random()*t.length)]}function i(t){return t*Math.PI/180}function s(t,e,i){return Math.max(e,Math.min(t,i))}function r(t){return 0==(t&t-1)}class n{constructor(t=0,e=0){this.length=2,this.x=t,this.y=e}static multiplyByScalar(t,e){return new n(t.x*e,t.y*e)}static addScalar(t,e){return new n(t.x+e,t.y+e)}static normalize(t){return(new n).setFromVec2(t).normalize()}static add(t,e){return new n(t.x+e.x,t.y+e.y)}static substract(t,e){return new n(t.x-e.x,t.y-e.y)}static dotProduct(t,e){return t.x*e.x+t.y*e.y}static applyMat3(t,e){return t.clone().applyMat3(e)}static lerp(t,e,i){return t.clone().lerp(e,i)}static rotate(t,e,i){return t.clone().rotate(e,i)}static equals(t,e,i=6){return!!t&&t.equals(e)}static getDistance(t,e){const i=e.x-t.x,s=e.y-t.y;return Math.sqrt(i*i+s*s)}static minMax(...t){return{min:new n(Math.min(...t.map((t=>t.x))),Math.min(...t.map((t=>t.y)))),max:new n(Math.max(...t.map((t=>t.x))),Math.max(...t.map((t=>t.y))))}}clone(){return new n(this.x,this.y)}set(t,e){return this.x=t,this.y=e,this}setFromVec2(t){return this.x=t.x,this.y=t.y,this}multiplyByScalar(t){return this.x*=t,this.y*=t,this}addScalar(t){return this.x+=t,this.y+=t,this}getMagnitude(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){const t=this.getMagnitude();return t&&(this.x/=t,this.y/=t),this}add(t){return this.x+=t.x,this.y+=t.y,this}substract(t){return this.x-=t.x,this.y-=t.y,this}dotProduct(t){return n.dotProduct(this,t)}applyMat3(t){if(9!==t.length)throw new Error("Matrix must contain 9 elements");const{x:e,y:i}=this,[s,r,,n,a,,o,h]=t;return this.x=e*s+i*n+o,this.y=e*r+i*a+h,this}lerp(t,e){return this.x+=e*(t.x-this.x),this.y+=e*(t.y-this.y),this}rotate(t,e){const i=Math.sin(e),s=Math.cos(e),r=this.x-t.x,n=this.y-t.y;return this.x=r*s-n*i+t.x,this.y=r*i+n*s+t.y,this}equals(t,e=6){return!!t&&+this.x.toFixed(e)==+t.x.toFixed(e)&&+this.y.toFixed(e)==+t.y.toFixed(e)}toArray(){return[this.x,this.y]}toIntArray(){return new Int32Array(this)}toFloatArray(){return new Float32Array(this)}*[Symbol.iterator](){yield this.x,yield this.y}}class a{constructor(t=0,e=0,i=0,s=1){this.x=t,this.y=e,this.z=i,this.w=s}static fromRotationMatrix(t){return(new a).setFromRotationMatrix(t)}static fromEuler(t){return(new a).setFromEuler(t)}static fromVec3Angle(t,e){return(new a).setFromVec3Angle(t,e)}static fromVec3s(t,e){return(new a).setFromVec3s(t,e)}static normalize(t){return t.clone().normalize()}static invert(t){return t.clone().normalize().invert()}static dotProduct(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}static getAngle(t,e){return t.getAngle(e)}static multiply(t,e){return t.clone().multiply(e)}static slerp(t,e,i){return t.clone().slerp(e,i)}static equals(t,e,i=6){return t.equals(e,i)}clone(){return new a(this.x,this.y,this.z,this.w)}set(t,e,i,s){return this.x=t,this.y=e,this.z=i,this.w=s,this}setFromVec3s(t,e){t=t.clone().normalize(),e=e.clone().normalize();let i=t.dotProduct(e)+1;if(i<1e-6)i=0,Math.abs(t.x)>Math.abs(t.z)?(this.x=-t.y,this.y=t.x,this.z=0):(this.x=0,this.y=-t.z,this.z=t.y);else{const{x:i,y:s,z:r}=t.crossProduct(e);this.x=i,this.y=s,this.z=r}return this.w=i,this.normalize()}setFromQ(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}setFromRotationMatrix(t){if(16!==t.length)throw new Error("Matrix must contain 16 elements");const[e,i,s,r,n,a,o,h,_,l,c,u,x,y,m,d]=t,w=e+a+c;if(w>0){const t=.5/Math.sqrt(1+w);this.set((o-l)*t,(_-s)*t,(i-n)*t,.25/t)}else if(e>a&&e>c){const t=2*Math.sqrt(1+e-a-c);this.set(.25*t,(n+i)/t,(_+s)/t,(o-l)/t)}else if(a>c){const t=2*Math.sqrt(1+a-e-c);this.set((n+i)/t,.25*t,(l+o)/t,(_-s)/t)}else{const t=2*Math.sqrt(1+c-e-a);this.set((_+s)/t,(l+o)/t,.25*t,(i-n)/t)}return this}setFromEuler(t){const e=Math.cos(t.x/2),i=Math.cos(t.y/2),s=Math.cos(t.z/2),r=Math.sin(t.x/2),n=Math.sin(t.y/2),a=Math.sin(t.z/2);switch(t.order){case"XYZ":this.x=r*i*s+e*n*a,this.y=e*n*s-r*i*a,this.z=e*i*a+r*n*s,this.w=e*i*s-r*n*a;break;case"XZY":this.x=r*i*s-e*n*a,this.y=e*n*s-r*i*a,this.z=e*i*a+r*n*s,this.w=e*i*s+r*n*a;break;case"YXZ":this.x=r*i*s+e*n*a,this.y=e*n*s-r*i*a,this.z=e*i*a-r*n*s,this.w=e*i*s+r*n*a;break;case"YZX":this.x=r*i*s+e*n*a,this.y=e*n*s+r*i*a,this.z=e*i*a-r*n*s,this.w=e*i*s-r*n*a;break;case"ZXY":this.x=r*i*s-e*n*a,this.y=e*n*s+r*i*a,this.z=e*i*a+r*n*s,this.w=e*i*s-r*n*a;break;case"ZYX":this.x=r*i*s-e*n*a,this.y=e*n*s+r*i*a,this.z=e*i*a-r*n*s,this.w=e*i*s+r*n*a}return this}setFromVec3Angle(t,e){const i=t.clone().normalize(),s=e/2,r=Math.sin(s);return this.x=i.x*r,this.y=i.y*r,this.z=i.z*r,this.w=Math.cos(s),this}getMagnitude(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}normalize(){const t=this.getMagnitude();return t&&(this.x/=t,this.y/=t,this.z/=t,this.w/=t),this}invert(){return this.normalize(),this.x*=-1,this.y*=-1,this.z*=-1,this}dotProduct(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}getAngle(t){return 2*Math.acos(Math.abs(s(this.dotProduct(t),-1,1)))}multiply(t){const{x:e,y:i,z:s,w:r}=this,{x:n,y:a,z:o,w:h}=t;return this.x=e*h+r*n+i*o-s*a,this.y=i*h+r*a+s*n-e*o,this.z=s*h+r*o+e*a-i*n,this.w=r*h-e*n-i*a-s*o,this}slerp(t,e){if(!(e=s(e,0,1)))return this;if(1===e)return this.setFromQ(t);const{x:i,y:r,z:n,w:a}=this,{x:o,y:h,z:_,w:l}=t,c=i*o+r*h+n*_+a*l;if(Math.abs(c)>=1)return this;const u=Math.acos(c),x=Math.sin(u);if(Math.abs(x)<1e-6)return this.x=.5*(i+o),this.y=.5*(r+h),this.z=.5*(n+_),this.w=.5*(a+l),this;const y=Math.sin((1-e)*u)/x,m=Math.sin(e*u)/x;return this.x=y*i+m*o,this.y=y*r+m*h,this.z=y*n+m*_,this.w=y*a+m*l,this}equals(t,e=6){return+this.x.toFixed(e)==+t.x.toFixed(e)&&+this.y.toFixed(e)==+t.y.toFixed(e)&&+this.z.toFixed(e)==+t.z.toFixed(e)&&+this.w.toFixed(e)==+t.w.toFixed(e)}}class o{constructor(t=0,e=0,i=0){this.length=3,this.x=t,this.y=e,this.z=i}static multiplyByScalar(t,e){return new o(t.x*e,t.y*e,t.z*e)}static addScalar(t,e){return new o(t.x+e,t.y+e,t.z+e)}static normalize(t){return(new o).setFromVec3(t).normalize()}static add(t,e){return new o(t.x+e.x,t.y+e.y,t.z+e.z)}static substract(t,e){return new o(t.x-e.x,t.y-e.y,t.z-e.z)}static dotProduct(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static crossProduct(t,e){return new o(t.y*e.z-t.z*e.y,t.z*e.x-t.x*e.z,t.x*e.y-t.y*e.x)}static onVector(t,e){return t.clone().onVector(e)}static onPlane(t,e){return t.clone().onPlane(e)}static applyMat3(t,e){return t.clone().applyMat3(e)}static applyMat4(t,e){return t.clone().applyMat4(e)}static lerp(t,e,i){return t.clone().lerp(e,i)}static equals(t,e,i=6){return!!t&&t.equals(e,i)}static getDistance(t,e){const i=e.x-t.x,s=e.y-t.y,r=e.z-t.z;return Math.sqrt(i*i+s*s+r*r)}static getAngle(t,e){return t.getAngle(e)}clone(){return new o(this.x,this.y,this.z)}set(t,e,i){return this.x=t,this.y=e,this.z=i,this}setFromVec3(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}multiplyByScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}getMagnitude(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}getAngle(t){const e=this.getMagnitude()*t.getMagnitude();if(!e)return Math.PI/2;const i=this.dotProduct(t)/e;return Math.acos(s(i,-1,1))}normalize(){const t=this.getMagnitude();return t&&(this.x/=t,this.y/=t,this.z/=t),this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}substract(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}dotProduct(t){return o.dotProduct(this,t)}crossProduct(t){return this.x=this.y*t.z-this.z*t.y,this.y=this.z*t.x-this.x*t.z,this.z=this.x*t.y-this.y*t.x,this}onVector(t){const e=this.getMagnitude();return e?t.clone().multiplyByScalar(t.clone().dotProduct(this)/(e*e)):this.set(0,0,0)}onPlane(t){return this.substract(this.clone().onVector(t))}applyMat3(t){if(9!==t.length)throw new Error("Matrix must contain 9 elements");const{x:e,y:i,z:s}=this,[r,n,a,o,h,_,l,c,u]=t;return this.x=e*r+i*o+s*l,this.y=e*n+i*h+s*c,this.z=e*a+i*_+s*u,this}applyMat4(t){if(16!==t.length)throw new Error("Matrix must contain 16 elements");const{x:e,y:i,z:s}=this,[r,n,a,o,h,_,l,c,u,x,y,m,d,w,g,f]=t,p=1/(e*o+i*c+s*m+f);return this.x=(e*r+i*h+s*u+d)*p,this.y=(e*n+i*_+s*x+w)*p,this.z=(e*a+i*l+s*y+g)*p,this}lerp(t,e){return this.x+=e*(t.x-this.x),this.y+=e*(t.y-this.y),this.z+=e*(t.z-this.z),this}equals(t,e=6){return!!t&&+this.x.toFixed(e)==+t.x.toFixed(e)&&+this.y.toFixed(e)==+t.y.toFixed(e)&&+this.z.toFixed(e)==+t.z.toFixed(e)}toArray(){return[this.x,this.y,this.z]}toIntArray(){return new Int32Array(this)}toFloatArray(){return new Float32Array(this)}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}class h{constructor(){this.length=16,this._matrix=new Array(this.length),this._matrix[0]=1,this._matrix[1]=0,this._matrix[2]=0,this._matrix[3]=0,this._matrix[4]=0,this._matrix[5]=1,this._matrix[6]=0,this._matrix[7]=0,this._matrix[8]=0,this._matrix[9]=0,this._matrix[10]=1,this._matrix[11]=0,this._matrix[12]=0,this._matrix[13]=0,this._matrix[14]=0,this._matrix[15]=1}get x_x(){return this._matrix[0]}get x_y(){return this._matrix[1]}get x_z(){return this._matrix[2]}get x_w(){return this._matrix[3]}get y_x(){return this._matrix[4]}get y_y(){return this._matrix[5]}get y_z(){return this._matrix[6]}get y_w(){return this._matrix[7]}get z_x(){return this._matrix[8]}get z_y(){return this._matrix[9]}get z_z(){return this._matrix[10]}get z_w(){return this._matrix[11]}get w_x(){return this._matrix[12]}get w_y(){return this._matrix[13]}get w_z(){return this._matrix[14]}get w_w(){return this._matrix[15]}static fromMat4(t){return(new h).setFromMat4(t)}static fromTRS(t,e,i){return(new h).setFromTRS(t,e,i)}static fromQuaternion(t){return(new h).setFromQuaternion(t)}static multiply(t,e){const i=new h;return i.set(t.x_x*e.x_x+t.x_y*e.y_x+t.x_z*e.z_x+t.x_w*e.w_x,t.x_x*e.x_y+t.x_y*e.y_y+t.x_z*e.z_y+t.x_w*e.w_y,t.x_x*e.x_z+t.x_y*e.y_z+t.x_z*e.z_z+t.x_w*e.w_z,t.x_x*e.x_w+t.x_y*e.y_w+t.x_z*e.z_w+t.x_w*e.w_w,t.y_x*e.x_x+t.y_y*e.y_x+t.y_z*e.z_x+t.y_w*e.w_x,t.y_x*e.x_y+t.y_y*e.y_y+t.y_z*e.z_y+t.y_w*e.w_y,t.y_x*e.x_z+t.y_y*e.y_z+t.y_z*e.z_z+t.y_w*e.w_z,t.y_x*e.x_w+t.y_y*e.y_w+t.y_z*e.z_w+t.y_w*e.w_w,t.z_x*e.x_x+t.z_y*e.y_x+t.z_z*e.z_x+t.z_w*e.w_x,t.z_x*e.x_y+t.z_y*e.y_y+t.z_z*e.z_y+t.z_w*e.w_y,t.z_x*e.x_z+t.z_y*e.y_z+t.z_z*e.z_z+t.z_w*e.w_z,t.z_x*e.x_w+t.z_y*e.y_w+t.z_z*e.z_w+t.z_w*e.w_w,t.w_x*e.x_x+t.w_y*e.y_x+t.w_z*e.z_x+t.w_w*e.w_x,t.w_x*e.x_y+t.w_y*e.y_y+t.w_z*e.z_y+t.w_w*e.w_y,t.w_x*e.x_z+t.w_y*e.y_z+t.w_z*e.z_z+t.w_w*e.w_z,t.w_x*e.x_w+t.w_y*e.y_w+t.w_z*e.z_w+t.w_w*e.w_w),i}static multiplyScalar(t,e){const i=new h;for(let s=0;s<this.length;s++)i._matrix[s]=t._matrix[s]*e;return i}static transpose(t){const e=new h;return e.set(t.x_x,t.y_x,t.z_x,t.w_x,t.x_y,t.y_y,t.z_y,t.w_y,t.x_z,t.y_z,t.z_z,t.w_z,t.x_w,t.y_w,t.z_w,t.w_w),e}static invert(t){const e=1/t.getDeterminant(),[i,s,r,n,a,o,_,l,c,u,x,y,m,d,w,g]=t._matrix;return(new h).set((_*y*d-l*x*d+l*u*w-o*y*w-_*u*g+o*x*g)*e,(n*x*d-r*y*d-n*u*w+s*y*w+r*u*g-s*x*g)*e,(r*l*d-n*_*d+n*o*w-s*l*w-r*o*g+s*_*g)*e,(n*_*u-r*l*u-n*o*x+s*l*x+r*o*y-s*_*y)*e,(l*x*m-_*y*m-l*c*w+a*y*w+_*c*g-a*x*g)*e,(r*y*m-n*x*m+n*c*w-i*y*w-r*c*g+i*x*g)*e,(n*_*m-r*l*m-n*a*w+i*l*w+r*a*g-i*_*g)*e,(r*l*c-n*_*c+n*a*x-i*l*x-r*a*y+i*_*y)*e,(o*y*m-l*u*m+l*c*d-a*y*d-o*c*g+a*u*g)*e,(n*u*m-s*y*m-n*c*d+i*y*d+s*c*g-i*u*g)*e,(s*l*m-n*o*m+n*a*d-i*l*d-s*a*g+i*o*g)*e,(n*o*c-s*l*c-n*a*u+i*l*u+s*a*y-i*o*y)*e,(_*u*m-o*x*m-_*c*d+a*x*d+o*c*w-a*u*w)*e,(s*x*m-r*u*m+r*c*d-i*x*d-s*c*w+i*u*w)*e,(r*o*m-s*_*m-r*a*d+i*_*d+s*a*w-i*o*w)*e,(s*_*c-r*o*c+r*a*u-i*_*u-s*a*x+i*o*x)*e)}static lookAt(t,e,i){const s=o.equals(t,e)?new o(0,0,1):o.substract(t,e).normalize();let r=o.crossProduct(i,s).normalize();r.getMagnitude()||(1===Math.abs(i.z)?s.x+=1e-5:s.z+=1e-5,s.normalize(),r=o.crossProduct(i,s).normalize());const n=o.crossProduct(s,r).normalize();return(new h).set(r.x,r.y,r.z,0,n.x,n.y,n.z,0,s.x,s.y,s.z,0,t.x,t.y,t.z,1)}static buildScale(t,e,i){return null!=e||(e=t),null!=i||(i=t),(new h).set(t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1)}static buildRotationX(t){const e=Math.cos(t),i=Math.sin(t);return(new h).set(1,0,0,0,0,e,i,0,0,-i,e,0,0,0,0,1)}static buildRotationY(t){const e=Math.cos(t),i=Math.sin(t);return(new h).set(e,0,-i,0,0,1,0,0,i,0,e,0,0,0,0,1)}static buildRotationZ(t){const e=Math.cos(t),i=Math.sin(t);return(new h).set(e,i,0,0,-i,e,0,0,0,0,1,0,0,0,0,1)}static buildTranslate(t,e,i){return(new h).set(1,0,0,0,0,1,0,0,0,0,1,0,t,e,i,1)}static buildOrthographic(t,e,i,s,r,n){return(new h).set(2/(s-i),0,0,0,0,2/(n-r),0,0,0,0,2/(t-e),0,(i+s)/(i-s),(r+n)/(r-n),(t+e)/(t-e),1)}static buildPerspective(t,e,...i){if(4===i.length){const[s,r,n,a]=i;return(new h).set(2*t/(r-s),0,0,0,0,2*t/(a-n),0,0,(r+s)/(r-s),(a+n)/(a-n),(t+e)/(t-e),-1,0,0,2*t*e/(t-e),0)}if(2===i.length){const[s,r]=i,n=Math.tan(.5*Math.PI-.5*s);return(new h).set(n/r,0,0,0,0,n,0,0,0,0,(t+e)/(t-e),-1,0,0,2*t*e/(t-e),0)}throw new Error("Incorrect args quantity")}static equals(t,e,i=6){return t.equals(e,i)}clone(){return(new h).set(this.x_x,this.x_y,this.x_z,this.x_w,this.y_x,this.y_y,this.y_z,this.y_w,this.z_x,this.z_y,this.z_z,this.z_w,this.w_x,this.w_y,this.w_z,this.w_w)}set(t,e,i,s,r,n,a,o,h,_,l,c,u,x,y,m){return this._matrix[0]=t,this._matrix[1]=e,this._matrix[2]=i,this._matrix[3]=s,this._matrix[4]=r,this._matrix[5]=n,this._matrix[6]=a,this._matrix[7]=o,this._matrix[8]=h,this._matrix[9]=_,this._matrix[10]=l,this._matrix[11]=c,this._matrix[12]=u,this._matrix[13]=x,this._matrix[14]=y,this._matrix[15]=m,this}reset(){return this._matrix[0]=1,this._matrix[1]=0,this._matrix[2]=0,this._matrix[3]=0,this._matrix[4]=0,this._matrix[5]=1,this._matrix[6]=0,this._matrix[7]=0,this._matrix[8]=0,this._matrix[9]=0,this._matrix[10]=1,this._matrix[11]=0,this._matrix[12]=0,this._matrix[13]=0,this._matrix[14]=0,this._matrix[15]=1,this}setFromMat4(t){for(let e=0;e<this.length;e++)this._matrix[e]=t._matrix[e];return this}setFromTRS(t,e,i){const s=2*e.x*e.x,r=2*e.y*e.x,n=2*e.z*e.x,a=2*e.y*e.y,o=2*e.z*e.y,h=2*e.z*e.z,_=2*e.x*e.w,l=2*e.y*e.w,c=2*e.z*e.w;return this.set((1-a-h)*i.x,(r+c)*i.x,(n-l)*i.x,0,(r-c)*i.y,(1-s-h)*i.y,(o+_)*i.y,0,(n+l)*i.z,(o-_)*i.z,(1-s-a)*i.z,0,t.x,t.y,t.z,1),this}setFromQuaternion(t){return this.setFromTRS(new o(0,0,0),t,new o(1,1,1))}multiply(t){const[e,i,s,r,n,a,o,h,_,l,c,u,x,y,m,d]=this._matrix,[w,g,f,p,z,v,b,A,M,E,T,S,F,U,I,P]=t._matrix;return this._matrix[0]=e*w+i*z+s*M+r*F,this._matrix[1]=e*g+i*v+s*E+r*U,this._matrix[2]=e*f+i*b+s*T+r*I,this._matrix[3]=e*p+i*A+s*S+r*P,this._matrix[4]=n*w+a*z+o*M+h*F,this._matrix[5]=n*g+a*v+o*E+h*U,this._matrix[6]=n*f+a*b+o*T+h*I,this._matrix[7]=n*p+a*A+o*S+h*P,this._matrix[8]=_*w+l*z+c*M+u*F,this._matrix[9]=_*g+l*v+c*E+u*U,this._matrix[10]=_*f+l*b+c*T+u*I,this._matrix[11]=_*p+l*A+c*S+u*P,this._matrix[12]=x*w+y*z+m*M+d*F,this._matrix[13]=x*g+y*v+m*E+d*U,this._matrix[14]=x*f+y*b+m*T+d*I,this._matrix[15]=x*p+y*A+m*S+d*P,this}multiplyScalar(t){for(let e=0;e<this.length;e++)this._matrix[e]*=t;return this}transpose(){const t=(new h).setFromMat4(this);return this.set(t.x_x,t.y_x,t.z_x,t.w_x,t.x_y,t.y_y,t.z_y,t.w_y,t.x_z,t.y_z,t.z_z,t.w_z,t.x_w,t.y_w,t.z_w,t.w_w),this}invert(){const t=1/this.getDeterminant(),[e,i,s,r,n,a,o,h,_,l,c,u,x,y,m,d]=this._matrix;return this.set((o*u*y-h*c*y+h*l*m-a*u*m-o*l*d+a*c*d)*t,(r*c*y-s*u*y-r*l*m+i*u*m+s*l*d-i*c*d)*t,(s*h*y-r*o*y+r*a*m-i*h*m-s*a*d+i*o*d)*t,(r*o*l-s*h*l-r*a*c+i*h*c+s*a*u-i*o*u)*t,(h*c*x-o*u*x-h*_*m+n*u*m+o*_*d-n*c*d)*t,(s*u*x-r*c*x+r*_*m-e*u*m-s*_*d+e*c*d)*t,(r*o*x-s*h*x-r*n*m+e*h*m+s*n*d-e*o*d)*t,(s*h*_-r*o*_+r*n*c-e*h*c-s*n*u+e*o*u)*t,(a*u*x-h*l*x+h*_*y-n*u*y-a*_*d+n*l*d)*t,(r*l*x-i*u*x-r*_*y+e*u*y+i*_*d-e*l*d)*t,(i*h*x-r*a*x+r*n*y-e*h*y-i*n*d+e*a*d)*t,(r*a*_-i*h*_-r*n*l+e*h*l+i*n*u-e*a*u)*t,(o*l*x-a*c*x-o*_*y+n*c*y+a*_*m-n*l*m)*t,(i*c*x-s*l*x+s*_*y-e*c*y-i*_*m+e*l*m)*t,(s*a*x-i*o*x-s*n*y+e*o*y+i*n*m-e*a*m)*t,(i*o*_-s*a*_+s*n*l-e*o*l-i*n*c+e*a*c)*t),this}getDeterminant(){const[t,e,i,s,r,n,a,o,h,_,l,c,u,x,y,m]=this._matrix;return s*a*_*u-i*o*_*u-s*n*l*u+e*o*l*u+i*n*c*u-e*a*c*u-s*a*h*x+i*o*h*x+s*r*l*x-t*o*l*x-i*r*c*x+t*a*c*x+s*n*h*y-e*o*h*y-s*r*_*y+t*o*_*y+e*r*c*y-t*n*c*y-i*n*h*m+e*a*h*m+i*r*_*m-t*a*_*m-e*r*l*m+t*n*l*m}getTRS(){const t=new o(this.w_x,this.w_y,this.w_z),e=this.getDeterminant(),i=new o(this.x_x,this.x_y,this.x_z).getMagnitude()*(e<0?-1:1),s=new o(this.y_x,this.y_y,this.y_z).getMagnitude(),r=new o(this.z_x,this.z_y,this.z_z).getMagnitude(),n=new o(i,s,r),_=(new h).set(this.x_x/i,this.x_y/i,this.x_z/i,0,this.y_x/s,this.y_y/s,this.y_z/s,0,this.z_x/r,this.z_y/r,this.z_z/r,0,0,0,0,1);return{t:t,r:a.fromRotationMatrix(_),s:n}}equals(t,e=6){for(let i=0;i<this.length;i++)if(+this._matrix[i].toFixed(e)!=+t._matrix[i].toFixed(e))return!1;return!0}applyScaling(t,e,i){const s=h.buildScale(t,e,i);return this.multiply(s)}applyTranslation(t,e,i){const s=h.buildTranslate(t,e,i);return this.multiply(s)}applyRotation(t,e){let i;switch(t){case"x":default:i=h.buildRotationX(e);break;case"y":i=h.buildRotationY(e);break;case"z":i=h.buildRotationZ(e)}return this.multiply(i)}toArray(){return this._matrix.slice()}toIntArray(){return new Int32Array(this)}toFloatArray(){return new Float32Array(this)}*[Symbol.iterator](){for(let t=0;t<this.length;t++)yield this._matrix[t]}}class _{constructor(t=0,e=0,i=0,s=1){this.length=4,this.x=t,this.y=e,this.z=i,this.w=s}static fromVec3(t){return new _(t.x,t.y,t.z)}static multiplyByScalar(t,e){return new _(t.x*e,t.y*e,t.z*e,t.w*e)}static addScalar(t,e){return new _(t.x+e,t.y+e,t.z+e,t.w+e)}static normalize(t){return(new _).setFromVec4(t).normalize()}static add(t,e){return new _(t.x+e.x,t.y+e.y,t.z+e.z,t.w+e.w)}static substract(t,e){return new _(t.x-e.x,t.y-e.y,t.z-e.z,t.w-e.w)}static dotProduct(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}static applyMat4(t,e){return t.clone().applyMat4(e)}static lerp(t,e,i){return t.clone().lerp(e,i)}static equals(t,e,i=6){return!!t&&t.equals(e,i)}clone(){return new _(this.x,this.y,this.z,this.w)}set(t,e,i,s){return this.x=t,this.y=e,this.z=i,this.w=s,this}setFromVec3(t){this.x=t.x,this.y=t.y,this.z=t.z,this.w=1}setFromVec4(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}multiplyByScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}getMagnitude(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}normalize(){const t=this.getMagnitude();return t&&(this.x/=t,this.y/=t,this.z/=t,this.w/=t),this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}substract(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}dotProduct(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}applyMat4(t){if(16!==t.length)throw new Error("Matrix must contain 16 elements");const{x:e,y:i,z:s,w:r}=this,[n,a,o,h,_,l,c,u,x,y,m,d,w,g,f,p]=t;return this.x=e*n+i*_+s*x+r*w,this.y=e*a+i*l+s*y+r*g,this.z=e*o+i*c+s*m+r*f,this.w=e*h+i*u+s*d+r*p,this}lerp(t,e){return this.x+=e*(t.x-this.x),this.y+=e*(t.y-this.y),this.z+=e*(t.z-this.z),this.w+=e*(t.w-this.w),this}equals(t,e=6){return!!t&&+this.x.toFixed(e)==+t.x.toFixed(e)&&+this.y.toFixed(e)==+t.y.toFixed(e)&&+this.z.toFixed(e)==+t.z.toFixed(e)&&+this.w.toFixed(e)==+t.w.toFixed(e)}toArray(){return[this.x,this.y,this.z,this.w]}toIntArray(){return new Int32Array(this)}toFloatArray(){return new Float32Array(this)}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}const l=35632,c=35633,u=34962,x=34963,y=33984,m=3553,d=34067,w=5121,g=5126,f=5120,p=5121,z=5122,v=5123,b=5124,A=5125,M=5126,E=35670,T={5120:1,5121:1,5122:2,5123:2,5124:4,5125:4,5126:4},S=35664,F=35665,U=35666,I=35674,P=35675,R=35676,C=35667,D=35668,L=35669,k=35671,N=35672,V=35673,B=35678,O=35680,q=35682,X=36293,G=36298,W=36300,Z=36306,Y=36308,j=35044,H=35048;function Q(t){if(t instanceof Int8Array)return f;if(t instanceof Uint8Array||t instanceof Uint8ClampedArray)return p;if(t instanceof Int16Array)return z;if(t instanceof Uint16Array)return v;if(t instanceof Int32Array)return b;if(t instanceof Uint32Array)return A;if(t instanceof Float32Array)return M;throw new Error("Unsupported array type")}class ${constructor(t,e,i){this._gl=t,this._location=t.getAttribLocation(e,i),this._name=i}get name(){return this._name}get type(){return this._type}get location(){return this._location}}class K extends ${constructor(t,e,i,s){if(super(t,e,i),this._type=Q(s),this._size=s.length,![1,2,3,4,9,16].includes(this._size))throw new Error("Incorrect constant value length")}set(){switch(this._gl.disableVertexAttribArray(this._location),this._type){case M:switch(this._size){case 1:this._gl.vertexAttrib1f(this._location,this._values[0]);break;case 2:this._gl.vertexAttrib2fv(this._location,this._values);break;case 3:this._gl.vertexAttrib3fv(this._location,this._values);break;case 4:this._gl.vertexAttrib4fv(this._location,this._values);break;case 9:const[t,e,i,s,r,n,a,o,h]=this._values;this._gl.vertexAttrib3f(this._location,t,e,i),this._gl.vertexAttrib3f(this._location+1,s,r,n),this._gl.vertexAttrib3f(this._location+2,a,o,h);break;case 16:const[_,l,c,u,x,y,m,d,w,g,f,p,z,v,b,A]=this._values;this._gl.vertexAttrib4f(this._location,_,l,c,u),this._gl.vertexAttrib4f(this._location+1,x,y,m,d),this._gl.vertexAttrib4f(this._location+2,w,g,f,p),this._gl.vertexAttrib4f(this._location+3,z,v,b,A);break;default:throw new Error("Incorrect constant value length")}break;default:throw new Error("Unsupported constant attribute type")}}destroy(){}}class J extends ${constructor(t,e,i,s,r,n){super(t,e,i),this._type=Q(s);const{usage:a,vectorSize:o,vectorNumber:h,stride:_,offset:l,normalize:c,divisor:x}=Object.assign({},J.defaultOptions,r),y=h?o*h*T[this.type]:0;this._stride=Math.min(255,Math.max(y,_)),this._vectorOffset=this._stride&&h?this._stride/h:0,this._vectorSize=o,this._vectorNumber=h,this._offset=l,this._normalize=c,this._divisor=x,this._instancedExt=n,this._buffer=t.createBuffer(),t.bindBuffer(u,this._buffer),t.bufferData(u,s,"static"===a?j:H)}updateData(t,e){this._gl.bindBuffer(u,this._buffer),this._gl.bufferSubData(u,e,t)}set(){this._gl.bindBuffer(u,this._buffer);for(let t=0,e=this._location;t<this._vectorNumber;t++,e++)this._gl.enableVertexAttribArray(e),this._gl.vertexAttribPointer(e,this._vectorSize,this._type,this._normalize,this._stride,this._offset+t*this._vectorOffset),this._divisor&&this._instancedExt&&this._instancedExt.vertexAttribDivisorANGLE(e,this._divisor)}destroy(){this._gl.deleteBuffer(this._buffer)}}J.defaultOptions={usage:"static",vectorSize:1,vectorNumber:1,stride:0,offset:0,normalize:!1};class tt extends ${constructor(t,e,i){let s;if(super(t,e,"index"),i instanceof Uint8Array||i instanceof Uint8ClampedArray)s=p;else if(i instanceof Uint16Array)s=v;else{if(!(i instanceof Uint32Array))throw new Error("Unsupported index type");s=A}this._type=s,this._buffer=t.createBuffer(),this._gl.bindBuffer(x,this._buffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,i,t.STATIC_DRAW)}set(){this._gl.bindBuffer(x,this._buffer)}destroy(){this._gl.deleteBuffer(this._buffer)}}class et{constructor(t,e,i){this._gl=t,this._location=t.getUniformLocation(e,i),this._name=i}get name(){return this._name}get type(){return this._type}get location(){return this._location}setSampleArray(t,e,i){}}class it extends et{constructor(t,e,i,s,r){super(t,e,i),this._value=r,this._type=s}set(){this._gl.uniform1i(this._location,this._value)}destroy(){}}class st extends et{constructor(t,e,i,s){super(t,e,i),this._type=5126,this._value=s}set(){this._gl.uniform1f(this._location,this._value)}destroy(){}}class rt extends et{constructor(t,e,i,s,r){switch(super(t,e,i),this._values=r,s){case b:case E:break;case C:case k:if(2!==r.length)throw new Error("Wrong values array length for a defined type");break;case D:case N:if(3!==r.length)throw new Error("Wrong values array length for a defined type");break;case L:case V:if(4!==r.length)throw new Error("Wrong values array length for a defined type");break;default:throw new Error(`Uniforms of type '${this._type}' are not supported by UniformIntArrayInfo`)}this._type=s}set(){switch(this._type){case b:case E:this._gl.uniform1iv(this._location,this._values);break;case C:case k:this._gl.uniform2iv(this._location,this._values);break;case D:case N:this._gl.uniform3iv(this._location,this._values);break;case L:case V:this._gl.uniform4iv(this._location,this._values);break;default:throw new Error(`Uniforms of type '${this._type}' are not supported by UniformIntArrayInfo`)}}destroy(){}}class nt extends et{constructor(t,e,i,s,r){switch(super(t,e,i),this._values=r,s){case M:break;case S:if(2!==r.length)throw new Error("Wrong values array length for a defined type");break;case F:if(3!==r.length)throw new Error("Wrong values array length for a defined type");break;case U:case I:if(4!==r.length)throw new Error("Wrong values array length for a defined type");break;case P:if(9!==r.length)throw new Error("Wrong values array length for a defined type");break;case R:if(16!==r.length)throw new Error("Wrong values array length for a defined type");break;default:throw new Error(`Uniforms of type '${this._type}' are not supported by UniformFloatArrayInfo`)}this._type=s}set(){switch(this._type){case M:this._gl.uniform1fv(this._location,this._values);break;case S:this._gl.uniform2fv(this._location,this._values);break;case F:this._gl.uniform3fv(this._location,this._values);break;case U:this._gl.uniform4fv(this._location,this._values);break;case I:this._gl.uniformMatrix2fv(this._location,!1,this._values);break;case P:this._gl.uniformMatrix3fv(this._location,!1,this._values);break;case R:this._gl.uniformMatrix4fv(this._location,!1,this._values);break;default:throw new Error(`Uniforms of type '${this._type}' are not supported by UniformFloatArrayInfo`)}}destroy(){}}class at extends et{constructor(t,e,i,s,r,n){switch(super(t,e,i),this._sampler=n,r){case B:case q:case G:case Z:this._target=m;break;case O:case X:case W:case Y:this._target=d;break;default:throw new Error("Unsupported sampler type "+r)}this._type=r,this._unit=s}}class ot extends at{constructor(t,e,i,s,r,n,a){super(t,e,i,s,n,a),this._texture=r}set(){this._gl.uniform1i(this._location,this._unit),this._gl.activeTexture(y+this._unit),this._gl.bindTexture(this._target,this._texture)}destroy(){this._gl.deleteTexture(this._texture)}}class ht extends at{constructor(t,e,i,s,r,n,a){super(t,e,i,s,n,a),this._textures=r}set(){const t=new Int32Array(this._textures.length);for(let e=0;e<this._textures.length;e++)t[e]=this._unit+e;this._gl.uniform1iv(this._location,t),this._textures.forEach(((e,i)=>{const s=y+t[i];this._gl.activeTexture(s),this._gl.bindTexture(this._target,e)}))}destroy(){this._textures.forEach((t=>this._gl.deleteTexture(t)))}}class _t{constructor(t,e,i){this._attributes=new Map,this._uniforms=new Map,this._offset=0,this._triangleCount=0;const s=_t.loadShader(t,c,e),r=_t.loadShader(t,l,i);this._extIndexed=t.getExtension("OES_element_index_uint");const n=t.createProgram();t.attachShader(n,s),t.attachShader(n,r),this._gl=t,this._program=n,t.linkProgram(n);if(!t.getProgramParameter(n,t.LINK_STATUS)){const e=t.getProgramInfoLog(n);throw this.destroy(),new Error("Error while linking program: "+e)}}get offset(){return this._offset}set offset(t){this._offset=Math.max(0,t)}static loadShader(t,e,i){const s=t.createShader(e);t.shaderSource(s,i),t.compileShader(s);if(!t.getShaderParameter(s,t.COMPILE_STATUS)){const e=t.getShaderInfoLog(s);throw t.deleteShader(s),new Error("Error while compiling shader: "+e)}return s}destroy(){this.clearUniforms(),this.clearAttributes(),this._gl.deleteProgram(this._program),this._gl.deleteShader(this._vertexShader),this._gl.deleteShader(this._fragmentShader)}setConstantScalarAttribute(t,e){if(!t||isNaN(e))return;const i=new K(this._gl,this._program,t,new Float32Array([e]));this.setAttribute(i)}setConstantVecAttribute(t,e){if(!t||!e)return;const i=new K(this._gl,this._program,t,e.toFloatArray());this.setAttribute(i)}setConstantMatAttribute(t,e){if(!t||!e)return;const i=new K(this._gl,this._program,t,e.toFloatArray());this.setAttribute(i)}setBufferAttribute(t,e,i){if(!t||!e?.length)return;const s=new J(this._gl,this._program,t,e,i);this.setAttribute(s)}setIndexAttribute(t){if(!t?.length)return;if(!this._extIndexed&&t instanceof Uint32Array)throw new Error("'OES_element_index_uint' extension not supported");const e=new tt(this._gl,this._program,t);this.setAttribute(e)}updateBufferAttribute(t,e,i){if(!t||!e)return;const s=this._attributes.get(t);s instanceof J&&s.updateData(e,i)}deleteAttribute(t){const e=this._attributes.get(t);e&&(e.destroy(),this._attributes.delete(t))}clearAttributes(){this._attributes.forEach(((t,e)=>this.deleteAttribute(e)))}setBoolUniform(t,e){const i=new it(this._gl,this._program,t,b,e?1:0);this.setUniform(i)}setBoolArrayUniform(t,e){if(!t||!e?.length)return;const i=new Int32Array(e.length);for(let t=0;t<e.length;t++)i[t]=e[t]?1:0;const s=new rt(this._gl,this._program,t,E,i);this.setUniform(s)}setIntUniform(t,e){if(!t||isNaN(e))return;const i=new it(this._gl,this._program,t,b,e);this.setUniform(i)}setIntArrayUniform(t,e){if(!t||!e?.length)return;const i=new rt(this._gl,this._program,t,b,e);this.setUniform(i)}setIntVecUniform(t,e){if(!t||!e)return;let i;switch(e.length){case 2:i=C;break;case 3:i=D;break;case 4:i=L;break;default:throw new Error("Incorrect vector length")}const s=new rt(this._gl,this._program,t,i,e.toIntArray());this.setUniform(s)}setFloatUniform(t,e){if(!t||isNaN(e))return;const i=new st(this._gl,this._program,t,e);this.setUniform(i)}setFloatArrayUniform(t,e){if(!t||!e?.length)return;const i=new nt(this._gl,this._program,t,M,e);this.setUniform(i)}setFloatVecUniform(t,e){if(!t||!e)return;let i;switch(e.length){case 2:i=S;break;case 3:i=F;break;case 4:i=U;break;default:throw new Error("Incorrect vector length")}const s=new nt(this._gl,this._program,t,i,e.toFloatArray());this.setUniform(s)}setFloatMatUniform(t,e){if(!t||!e)return;let i;switch(e.length){case 4:i=I;break;case 9:i=P;break;case 16:i=R;break;default:throw new Error("Incorrect matrix length")}const s=new nt(this._gl,this._program,t,i,e.toFloatArray());this.setUniform(s)}createTexture(t,e,i,s,n,a,o=!1){if(s===w){if(!(t instanceof Uint8Array))throw new Error("Invalid data array type: must be Uint8Array")}else if(s===g){if(!(t instanceof Float32Array))throw new Error("Invalid data array type: must be Float32Array");if(!this._gl.getExtension("OES_texture_float")||!this._gl.getExtension("OES_texture_float_linear"))throw new Error("Float texture extensions not supported")}else if(!(t instanceof Uint16Array))throw new Error("Invalid data array type: must be Uint16Array");if(t.length!==n*a)throw new Error("Invalid data array length");const h=this._gl,_=h.createTexture();return h.bindTexture(e,_),h.texImage2D(e,0,i,n,a,0,i,s,t),o?(h.texParameteri(e,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(e,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),h.texParameteri(e,h.TEXTURE_MIN_FILTER,h.NEAREST),h.texParameteri(e,h.TEXTURE_MAG_FILTER,h.NEAREST)):r(n)&&r(a)?h.generateMipmap(e):(h.texParameteri(e,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(e,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),h.texParameteri(e,h.TEXTURE_MIN_FILTER,h.LINEAR)),_}loadTexture(t,e=new Uint8Array([0,0,0,255])){if(!(t&&e instanceof Uint8Array))throw new Error("Invalid arguments");const i=this._gl,s=i.createTexture();i.bindTexture(i.TEXTURE_2D,s);const n=i.RGBA,a=i.RGBA,o=i.UNSIGNED_BYTE;i.texImage2D(i.TEXTURE_2D,0,n,1,1,0,a,o,e);const h=new Image;return h.onload=function(){i.bindTexture(i.TEXTURE_2D,s),i.texImage2D(i.TEXTURE_2D,0,n,a,o,h),r(h.width)&&r(h.height)?i.generateMipmap(i.TEXTURE_2D):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR))},h.src=t,s}setTexture(t,e,i=B,s=0){if(!t||!e)return;const r=new ot(this._gl,this._program,t,s,e,i);this._uniforms.set(t,r)}setTextureArray(t,e,i=B,s=0){if(!t||!e?.length)return;const r=new ht(this._gl,this._program,t,s,e,i);this._uniforms.set(t,r)}createAndSet2dTexture(t,e,i,s,r,n,a,o=!1,h=0){if(!t)return;const _=this.createTexture(e,i,s,r,n,a,o);this.setTexture(t,_,i,h)}loadAndSet2dTexture(t,e,i=0,s=new Uint8Array([0,0,0,255])){if(!t)return;const r=this.loadTexture(e,s);this.setTexture(t,r,B,i)}deleteUniform(t){const e=this._uniforms.get(t);e&&(e.destroy(),this._uniforms.delete(t))}clearUniforms(){this._uniforms.forEach(((t,e)=>this.deleteUniform(e)))}setAttribute(t){const e=this._attributes.get(t.name);e&&e.destroy(),this._attributes.set(t.name,t)}setUniform(t){const e=this._attributes.get(t.name);e&&e.destroy(),this._uniforms.set(t.name,t)}set(){this._gl.useProgram(this._program),this._attributes.forEach((t=>t.set())),this._uniforms.forEach((t=>t.set()))}}class lt extends _t{get triangleCount(){return this._triangleCount}set triangleCount(t){this._triangleCount=Math.max(0,t)}constructor(t,e,i){super(t,e,i)}render(t=!0){this._gl.viewport(0,0,this._gl.canvas.width,this._gl.canvas.height),t&&this.resetRender(),this.set();const e=this._attributes.get("index");e?this._gl.drawElements(this._gl.TRIANGLES,3*this._triangleCount,e.type,this._offset):this._gl.drawArrays(this._gl.TRIANGLES,this._offset,3*this._triangleCount)}resetRender(){const t=this._gl;t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.cullFace(t.BACK),t.enable(t.CULL_FACE),t.enable(t.DEPTH_TEST),t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)}}class ct extends lt{constructor(t,e,i){if(super(t,e,i),this._instanceCount=0,this._extInstanced=t.getExtension("ANGLE_instanced_arrays"),!this._extInstanced)throw this.destroy(),new Error("'ANGLE_instanced_arrays' extension not supported")}get instanceCount(){return this._instanceCount}set instanceCount(t){this._instanceCount=Math.max(0,t)}render(t=!0){this._gl.viewport(0,0,this._gl.canvas.width,this._gl.canvas.height),t&&this.resetRender(),this.set();const e=this._attributes.get("index");e?this._extInstanced.drawElementsInstancedANGLE(this._gl.TRIANGLES,3*this._triangleCount,e.type,this._offset,this._instanceCount):this._extInstanced.drawArraysInstancedANGLE(this._gl.TRIANGLES,this._offset,3*this._triangleCount,this._instanceCount)}setInstancedBufferAttribute(t,e,i){if(!e?.length)return;const s=new J(this._gl,this._program,t,e,i,this._extInstanced);this.setAttribute(s)}}class ut{constructor(t=1){this._positions=new Float32Array([-t,-t,0,t,-t,0,-t,t,0,t,t,0]),this._normals=new Float32Array([0,0,1,0,0,1,0,0,1,0,0,1]),this._uvs=new Float32Array([0,1,1,1,0,0,1,0]),this._indices=new Uint32Array([0,1,2,2,1,3])}get positions(){return this._positions}get normals(){return this._normals}get uvs(){return this._uvs}get indices(){return this._indices}}class xt{constructor(t){this._dimensions=new _,this._sceneDimensions=new o,this._lastFrameTimestamp=0,this._options=t,this._margin=Math.max(0,t.size[1],t.lineLength||0,t.clickR||0,t.hoverR||0),this._doubleMargin=2*this._margin;const e=new ut(1);this._primitive=e}get position(){return this._primitive.positions}get uv(){return this._primitive.uvs}get index(){return this._primitive.indices}get triangles(){return this._primitive.indices.length/3}get length(){return this._length}get iMatrix(){const t=16*this._length;this._iMatrix&&this._iMatrix.length===t||(this._iMatrix=new Float32Array(t));const e=this._iMatrix;for(let t=0;t<this._length;t++)e.set(this._iDataSorted[t].mat.toFloatArray(),16*t);return e}get iUv(){const t=2*this._length;this._iUv&&this._iUv.length===t||(this._iUv=new Float32Array(t));const e=this._iUv;for(let t=0;t<this._length;t++)e.set(this._iDataSorted[t].uv,2*t);return e}get iColor(){const t=4*this._length;this._iColor&&this._iColor.length===t||(this._iColor=new Float32Array(t));const e=this._iColor;for(let t=0;t<this._length;t++)e.set(this._iDataSorted[t].color,4*t);return e}get sceneDimensions(){return this._sceneDimensions}updateData(t,e,i,s){const r=s-this._lastFrameTimestamp;this._lastFrameTimestamp=s,this.updateDimensions(t)&&this.updateLength();const a=new n;for(let t=0;t<this._length;t++)this.updateInstance(t,r,a);this._iDataSorted.sort(((t,e)=>t.mat.w_z-e.mat.w_z))}updateInstance(t,e,i){const s=3*t,r=s+1,n=r+1,a=this._iPositions[n],[o,h]=this.getSceneDimensionsAtZ(a,i),_=this.updateNextFrameZ(n,e),[l,c]=this.getSceneDimensionsAtZ(_,i),{x:u,y:x}=this._sceneDimensions;this._iData[t].mat.reset().applyRotation("z",this.updateAngularRotation(t,e)).applyScaling(this._iSizes[s]/u,this._iSizes[r]/x,this._iSizes[n]).applyTranslation(this.shiftCoordToClipSpace(this.updateNextFrameCoord(s,u,o,l,e),l),this.shiftCoordToClipSpace(this.updateNextFrameCoord(r,x,h,c,e),c),_)}getSceneDimensionsAtZ(t,e){const{x:s,y:r,z:a}=this._sceneDimensions;let o=t*a;const h=this._dimensions.w;o<h?o-=h:o+=h;const _=i(this._options.fov),l=2*Math.tan(_/2)*Math.abs(o),c=l/this._dimensions.y*this._dimensions.x,u=l+this._doubleMargin,x=(c+this._doubleMargin)/s,y=u/r;return e?e.set(x,y):new n(x,y)}updateDimensions(t){const e=!t.equals(this._dimensions);return e&&(this._dimensions.setFromVec4(t),this._sceneDimensions.set(t.x+this._doubleMargin,t.y+this._doubleMargin,t.z)),e}updateLength(){const i=Math.floor(this._options.fixedNumber??this._options.density*this._sceneDimensions.x*this._sceneDimensions.y);if(this._length!==i){const s=this._length||0,r=this._iData||[],n=3*i,a=new Float32Array(n),o=this._iSizes,_=o?.length||0,l=Math.min(n,_);_&&a.set(o.subarray(0,l),0);for(let e=l;e<n;){const i=t(this._options.size[0],this._options.size[1]);a[e++]=i,a[e++]=i,a[e++]=1}this._iSizes=a;const c=3*i,u=new Float32Array(c),x=this._iPositions,y=x?.length||0,m=Math.min(c,y);y&&u.set(x.subarray(0,m),0);for(let e=m;e<c;e+=3)u.set([t(0,2),t(0,2),t(-.999,-.001)],e);this._iPositions=u;const d=i,w=new Float32Array(d),g=this._iPositions,f=g?.length||0,p=Math.min(d,f);f&&w.set(g.subarray(0,p),0);for(let t=p;t<d;t++)w.set([0],t);this._iAngularPositions=w;const z=3*i,v=new Float32Array(z),b=this._iVelocities,A=b?.length||0,M=Math.min(z,A);A&&v.set(b.subarray(0,M),0);for(let e=M;e<z;)v[e++]=t(this._options.velocityX[0],this._options.velocityX[1]),v[e++]=t(this._options.velocityY[0],this._options.velocityY[1]),v[e++]=t(this._options.velocityZ[0],this._options.velocityZ[1]);this._iVelocities=v;const E=i,T=new Float32Array(E),S=this._iAngularVelocities,F=S?.length||0,U=Math.min(E,F);F&&T.set(S.subarray(0,U),0);for(let e=U;e<E;e++)T[e]=t(this._options.angularVelocity[0],this._options.angularVelocity[1]);this._iAngularVelocities=T;const I=new Array(i);let P;const R=Math.min(i,s);for(let t=0;t<R;t++)I[t]=r[t];if(R<i){let s,r,n;for(let a=R;a<i;a++)P=a%2?a+1:a,s=new Float32Array(2),s[0]=this._options.textureMap[P%this._options.textureMap.length],s[1]=this._options.textureMap[(P+1)%this._options.textureMap.length],r=new Float32Array(4),n=e(this._options.colors),r[0]=n[0]/255,r[1]=n[1]/255,r[2]=n[2]/255,r[3]=this._options.fixedOpacity||t(this._options.opacityMin??0,1),I[a]={mat:new h,uv:s,color:r}}this._iData=I,this._iDataSorted=I.slice(),this._length=i}}updateNextFrameZ(t,e){const i=this._iPositions[t],s=this._iVelocities[t];let r=i+e*s/this._sceneDimensions.z;return r>-.001?(r=-.001,this._iVelocities[t]=-s):r<-.999&&(r=-.999,this._iVelocities[t]=-s),this._iPositions[t]=r,r}updateNextFrameCoord(t,e,i,s,r){const n=this._iPositions[t],a=this._iVelocities[t],o=this.calcNextFrameCoord(n,e,i,s,r,a);return this._iPositions[t]=o,o}updateAngularRotation(t,e){const i=(this._iAngularPositions[t]+e*this._iAngularVelocities[t])%(2*Math.PI);return this._iAngularPositions[t]=i,i}calcNextFrameCoord(t,e,i,s,r,n){return(t/i*s+r*n/e)%s}shiftCoordToClipSpace(t,e){return(t<0?t+e:t)-e/2}}const yt="\n  #pragma vscode_glsllint_stage : vert\n\n  attribute vec4 aColorInst;\n  attribute vec3 aPosition;\n  attribute vec2 aUv;\n  attribute vec2 aUvInst;\n  attribute mat4 aMatInst;\n\n  uniform int uTexSize;\n  uniform vec2 uResolution;\n  uniform mat4 uModel;\n  uniform mat4 uView;\n  uniform mat4 uProjection;\n\n  varying vec4 vColor;\n  varying vec2 vUv;\n\n  void main() {\n    VCOLOR_ASSIGNMENT\n\n    float texSize = float(uTexSize);\n    vUv = vec2((aUvInst.x + aUv.x) / texSize, (aUvInst.y + aUv.y) / texSize);\n\n    gl_Position = uProjection * uView * uModel * aMatInst * vec4(aPosition, 1.0);\n  }\n";class mt{constructor(t,e){this._lastResolution=new n,this._dimensions=new _,this._gl=t;const i=e;if(this._options=i,!i.textureUrl)throw new Error("Texture URL not defined");this._fov=i.fov,this._depth=i.depth,this._program=new ct(t,this.vertexShader,this.fragmentShader),this._data=new xt(i),this._program.loadAndSet2dTexture("uTex",i.textureUrl),this._program.setIntUniform("uTexSize",i.textureSize||1),this._program.setBufferAttribute("aPosition",this._data.position,{vectorSize:3}),this._program.setBufferAttribute("aUv",this._data.uv,{vectorSize:2}),this._program.setIndexAttribute(this._data.index)}get vertexShader(){return yt.replace("VCOLOR_ASSIGNMENT",this._options?.depthAffectsOpacity?"vColor = vec4(aColorInst.x, aColorInst.y, aColorInst.z, aColorInst.w * (1.0 - abs(aMatInst[3][2])));":"vColor = aColorInst;")}get fragmentShader(){return"\n  #pragma vscode_glsllint_stage : frag  \n\n  precision highp float;\n\n  uniform sampler2D uTex;\n\n  varying vec4 vColor;\n  varying vec2 vUv;\n\n  void main() {\n    vec4 color = texture2D(uTex, vUv);\n    gl_FragColor = color * vColor;\n  }\n"}prepareNextFrame(t,e,s,r){if(!t.equals(this._lastResolution)){const n=Math.tan(.5*Math.PI-.5*i(this._fov))*t.y/2;this.resize(t),this._program.setIntVecUniform("uResolution",t),this._lastResolution.setFromVec2(t),this._dimensions.set(t.x,t.y,this._depth,n),this._data.updateData(this._dimensions,e,s,r);const a=(new h).applyTranslation(0,0,-n);this._program.setFloatMatUniform("uView",a);const o=this._data.sceneDimensions,_=(new h).applyScaling(o.x,o.y,this._depth);this._program.setFloatMatUniform("uModel",_);const l=h.buildPerspective(n,n+this._depth,-t.x/2,t.x/2,-t.y/2,t.y/2);this._program.setFloatMatUniform("uProjection",l),this._program.setInstancedBufferAttribute("aColorInst",this._data.iColor,{vectorSize:4,vectorNumber:1,divisor:1,usage:"dynamic"}),this._program.setInstancedBufferAttribute("aMatInst",this._data.iMatrix,{vectorSize:4,vectorNumber:4,divisor:1,usage:"dynamic"}),this._program.setInstancedBufferAttribute("aUvInst",this._data.iUv,{vectorSize:2,divisor:1,usage:"dynamic"})}else this._data.updateData(this._dimensions,e,s,r),this._program.updateBufferAttribute("aColorInst",this._data.iColor,0),this._program.updateBufferAttribute("aMatInst",this._data.iMatrix,0),this._program.updateBufferAttribute("aUvInst",this._data.iUv,0)}renderFrame(){this._program.triangleCount=this._data.triangles,this._program.instanceCount=this._data.length,this._program.render()}clear(){this._program.resetRender()}destroy(){this._program.destroy(),this._gl.getExtension("WEBGL_lose_context").loseContext()}resize(t){this._gl.canvas.width=t.x,this._gl.canvas.height=t.y}}const dt={expectedFps:60,fixedNumber:null,density:2e-4,depth:1e3,fov:120,size:[16,64],velocityX:[-.1,.1],velocityY:[-.1,.1],velocityZ:[-.1,.1],angularVelocity:[-.001,.001],blur:1,colors:[[255,255,255],[255,244,193],[250,239,219]],fixedOpacity:null,opacityMin:.5,opacityStep:0,depthAffectsOpacity:!0,drawLines:!0,lineColor:[113,120,146],lineLength:150,lineWidth:2,onClick:null,onHover:null,createN:10,clickR:200,hoverR:150,showPointerEffectArea:!1,textureUrl:null,textureSize:null,textureMap:null};class wt{constructor(t,e,i){this._resolution=new n,this._pointerPosition=new n,this._animationStartTimeStamp=0,this._lastFrameTimeStamp=0,this._lastPreparationTime=0,this._lastRenderTime=0,this.onResize=()=>{const t=window.devicePixelRatio,e=this._container.getBoundingClientRect(),i=Math.floor(e.width*t),s=Math.floor(e.height*t);this._resolution.set(i,s)},this.onPointerMove=t=>{const e=window.devicePixelRatio,i=this._container.getBoundingClientRect(),s=i.left+document.documentElement.scrollLeft,r=i.top+document.documentElement.scrollTop,n=(t.clientX-s+window.pageXOffset)*e,a=(t.clientY-r+window.pageYOffset)*e;this._pointerPosition.set(n,a)},this.onPointerDown=()=>{this._pointerIsDown=!0},this.onPointerUp=()=>{this._pointerIsDown=!1},this._options=e,this._container=t,this._controlType=i,this.initCanvas(),this.initControl(),this.addEventListeners()}destroy(){this.stop(),this.removeEventListeners(),this._control.destroy(),this._canvas.remove()}start(){if(this._animationStartTimeStamp){const t=performance.now()-this._lastFrameTimeStamp;this._animationStartTimeStamp+=t}this._animationTimerId=setInterval((()=>{const t=performance.now(),e=t-this._animationStartTimeStamp;this._control.prepareNextFrame(this._resolution,this._pointerPosition,this._pointerIsDown,e);const i=performance.now();this._lastPreparationTime=i-t,requestAnimationFrame((()=>{const t=performance.now();this._control.renderFrame();const e=performance.now();this._lastFrameTimeStamp=e,this._lastRenderTime=e-t}))}),1e3/this._options.expectedFps)}pause(){this._animationTimerId&&(clearInterval(this._animationTimerId),this._animationTimerId=null)}stop(){this.pause(),this._animationStartTimeStamp=0,window.setTimeout((()=>this._control.clear()),20)}initCanvas(){const t=document.createElement("canvas");t.id=crypto.getRandomValues(new Uint32Array(4)).join("-"),t.style.display="block",t.style.width="100%",t.style.height="100%",t.style.filter=`blur(${this._options.blur}px)`,console.log(this._options),this._container.append(t),this._canvas=t,this.onResize()}initControl(){this._control=new this._controlType(this._canvas.getContext("webgl"),this._options)}addEventListeners(){this._resizeObserver=new ResizeObserver(this.onResize),this._resizeObserver.observe(this._container),this._container.addEventListener("pointermove",this.onPointerMove),window.addEventListener("pointerdown",this.onPointerDown),window.addEventListener("pointerup",this.onPointerUp),window.addEventListener("blur",this.onPointerUp)}removeEventListeners(){this._resizeObserver.unobserve(this._container),this._resizeObserver.disconnect(),this._resizeObserver=null,this._container.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerdown",this.onPointerDown),window.removeEventListener("pointerup",this.onPointerUp),window.removeEventListener("blur",this.onPointerUp)}}class gt{static createSpriteAnimation(t,e=null){const i=document.querySelector(t);if(!i)throw new Error("Container not found");if("static"===window.getComputedStyle(i).getPropertyValue("position"))throw new Error("Container is not positioned");const s=Object.assign({},dt,e);return new wt(i,s,mt)}}export{gt as WGLAnimationFactory};
